{% import 'macros.html' as base_macros with context %}

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <link href="{{ url('news:feed') }}" type="application/atom+xml" rel="alternate" title="Новости" />
    <link href="{{ url('forum:feed') }}" type="application/atom+xml" rel="alternate" title="Форум" />
    <title>{% block title%}Сказка{% endblock %}</title>

    {% if settings.GA_CODE %}
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', "{{ settings.GA_CODE }}" ]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    {% endif %}

    <link rel="stylesheet" type="text/css" href="{{ LESS_CSS_URL }}main.css" />
    <link rel="stylesheet" type="text/css" href="{{ LESS_CSS_URL }}javascript.css" />

    <script src="{{ STATIC_URL }}plugins/jquery/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}plugins/jquery/jquery-ui-1.8.9/js/jquery-ui-1.8.9.custom.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="{{ STATIC_URL }}plugins/jquery/jquery.url.js" type="text/javascript"></script>

    <script src="{{ STATIC_URL }}plugins/spin/spin.min.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}plugins/jquery/jquery.spin.js" type="text/javascript"></script>

    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}bootstrap/css/bootstrap.min.css" />
    <script src="{{ STATIC_URL }}bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

    {% if settings.ADDTHIS %}
    <script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-505d67570062215a"></script>
    {% endif %}

    <script src="{{ STATIC_URL }}plugins/globalize/globalize.js"></script>
    <script src="{{ STATIC_URL }}plugins/globalize/cultures/globalize.culture.ru.js"></script>
    <script src="{{ STATIC_URL }}common/base.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}common/dialog.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}common/forms.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}common/urls.js" type="text/javascript"></script>

    {% if settings.DEBUG %}
    <script src="{{ STATIC_URL }}common/debug.js" type="text/javascript"></script>
    {% endif %}

    <script type="text/javascript">

STATIC_URL = "{{ STATIC_URL }}"

{% if resource.account.is_authenticated() %}
pgf.base.settings.init("account_{{resource.account.id}}");
{% else %}
pgf.base.settings.init("anonimues");
{% endif %}

jQuery(document).ready(function() {

    Globalize.culture('ru');
    pgf.base.AutoFormatTime();

    jQuery.ajaxSetup({
        beforeSend: function(xhr, settings) {

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken') );
            }
        }
    });

    jQuery('.pgf-fast-registration').click(function(e){
        e.preventDefault();
        pgf.forms.Post({ OnSuccess: function(data)
                         {
                             location.href = "{{ url('game:') }}";
                         },
                         action: jQuery(e.currentTarget).attr('href')
                       });
    });

    jQuery('[rel="tooltip"]').tooltip(pgf.base.tooltipsArgs)
    jQuery('[rel="popover"]').popover(pgf.base.popoverArgs)

    ///////////////////////////
    // BBField processing
    function InitializeBBFileds(container) {

        jQuery('.pgf-bbfield', container).each(function(i, e){
            var id = jQuery(e).attr('id');
            pgf.base.AddPreview('#'+id, 'textarea', "{{url('portal:preview')}}");
            pgf.base.InitBBFields('#'+id);
        });
    }

    InitializeBBFileds(document);

    jQuery(document).bind(pgf.ui.dialog.DIALOG_OPENED, function(e, dialog) {
        InitializeBBFileds(dialog);
    });
    /////////////////////////
});
    </script>

    {% block head %}{% endblock%}
  </head>
  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">

          <a class="brand" href="{{ url('portal:') }}">Сказка</a>

          <ul class="nav">
            {{ base_macros.main_menu_item("forum", url("forum:"), "Форум") }}
            {{ base_macros.main_menu_item("guide", "#", "Путеводитель", [(url("guide:game"), "Описание игры"),
                                                                         (url("guide:might"), "Могущество игрока"),
                                                                         (url("guide:hero-abilities"), "Способности героев"),
                                                                         (url("guide:hero-preferences"), "Предпочтения героев"),
                                                                         (url("guide:quests"), "Задания"),
                                                                         (url("guide:persons"), "Персонажи"),
                                                                         (url("guide:cities"), "Города"),
                                                                         (url("guide:politics"), "Политика"),
                                                                         (url("guide:map"), "Карта"),
                                                                         (url("guide:pvp"), "PvP"),
                                                                         (url("guide:mobs:"), "Бестиарий"),
                                                                         (url("guide:artifacts:"), "Артефакты"),
                                                                         (url("cms:world:"), get_cms_section_info("world").caption),
                                                                         ('-', '<li class="divider"></li>'),
                                                                         (url("guide:account-types"), "Общее"),
                                                                         (url("cms:development:"), get_cms_section_info("development").caption),
                                                                         (faq_url(), "FAQ")]) }}
            {{ base_macros.main_menu_item("community", "#", "Сообщество", [(url("accounts:"), "Игроки"),
                                                                           (url("game:ratings:"), "Рейтинги"),
                                                                           (url("game:pvp:calls"), "Арена")]) }}

            {{ base_macros.main_menu_item("world", "#", "Мир", [(url("game:bills:"), "Политика"),
                                                                (url("game:phrase-candidates:"), "Лингвистика"),
                                                                (url("blogs:posts:"), "Фольклор"),
                                                                (url("game:chronicle:"), "Летопись") ] ) }}

            {% if resource.account.is_authenticated() %}
            {{ base_macros.main_menu_item("game", url("game:"), "<span class='game-link'>Игра</span>") }}
            {% else %}
            {{ base_macros.main_menu_item("map", url("game:map:"), "<span class='game-link'>Карта</span>") }}
            <li><a href="{{ url('accounts:registration:fast') }}" class="pgf-fast-registration attention-link"><strong>создать героя</strong></a></li>
            {% endif %}

          </ul>

          <ul class="nav pull-right">
            <li>
              {% set game_time = resource.time.game_time %}
              <p id="time-block" class="navbar-text">
                <span class="pgf-game-date">{{ game_time.verbose_date}}</span>
                <span class="pgf-game-time">{{ game_time.verbose_time }}</span>
              </p>
            </li>
            <li class="divider-vertical"></li>

            {% if resource.account.is_authenticated() %}

            {% if resource.account.new_messages_number > 0 %}
            <li rel="tooltip"  title="У вас есть новые сообщения">
              <a href="{{ url('accounts:messages:') }}">
                <i class="icon-white icon-envelope" style="vertical-align: middle;"></i> ({{resource.account.new_messages_number}})
              </a>
            </li>
            {% endif %}

            {{ base_macros.main_menu_item("profile",
                                          "#",
                                          resource.account.nick if not resource.account.is_fast else "Настройки",
                                          [(url("accounts:profile:show"), "Профиль"),
                                           (url("accounts:payments:shop"), "Магазин"),
                                           (url("accounts:friends:"), "Друзья"),
                                           (url("accounts:messages:"), "Сообщения"),
                                           (url("forum:subscriptions:"), "Подписки"),
                                           (url("accounts:show", resource.account.id), "Моя страница"),
                                           (url("game:heroes:my-hero"), "Мой герой"),
                                           ('-', '<li class="divider"></li>'),
                                           (logout_url(), "Выход")] ) }}

            {% else %}
            <li><a href="{{ login_url(resource.request.get_full_path()) }}">Войти</a></li>
            {% endif %}
          </ul>

        </div>
      </div>
    </div>

    {% block body %}

    {% if settings.DEBUG %}
    <ul style="position: absolute; right: 0; top: 60px;">
      {% block debug_menu%}
      {% endblock %}
    </ul>
    {% endif %}

    <div id="main-container">
      <div id="content" class="container">

        {% block content_header %}

        {% if resource.account.is_authenticated() and resource.account.is_fast %}
        <div class="alert alert-info">
          {% block fast_account_warning %}
          ВНИМАНИЕ! Ваша игра доступна только с этого компьютера. Для игры из другого места необходимо указать имя, email и пароль в своём <a href="{{ url('accounts:profile:show') }}">профиле</a> (подробнее о быстрой регистрации можно почитать в <a href="{{ url('guide:') }}">Путеводителе по Сказке</a>).
          {% endblock %}
        </div>
        {% endif %}
        {% endblock %}

        {% block content %}
        {% endblock %}
      </div>
    </div>

    <footer role="contentinfo" class="container">
      <div class="row">
        <div class="span12">
          <ul class="unstyled">
            <li>© 2011-{{now().year}} {{settings.OWNER_SHORT}}</li>
            <li>поддержка: <a href="mailto:{{ settings.EMAIL_SUPPORT }}">{{ settings.EMAIL_SUPPORT_SHORT }}</a></li>
            <li>использована часть иконок из набора <a href="http://glyphicons.com" target="_blank">Glyphicons</a></li>
          </ul>
        </div>
      </div>
    </footer>

    {% endblock %}
  </body>
</html>
