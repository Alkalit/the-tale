{% import 'chronicle/macros.html' as chronicle_macros with context %}
{% import 'map/macros.html' as map_macros with context %}

<div class="modal hide place-description-dialog">

  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3 class="pgf-dialog-title dialog-title">
      {% if place %}
      <span style="vertical-align: middle;" class="badge">{{ place.size }}</span>
      <span style="vertical-align: middle;">
        {% if place.modifier %}{{ place.modifier.NAME }}{% endif %}
        {{ place.name }}

        {% if hero and hero.preferences.place and hero.preferences.place.id == place.id %}
        <span class="badge badge-success">родной город</span>
        {% endif %}

        <small>
          обновлено в
          <span class="pgf-format-time" data-timestamp="{{ place.updated_at|timestamp }}"></span>
        </small>

      </span>

      {% elif building %}
      <span>
        {{ building.name }}
      </span>
      {% else %}
      Квадрат {{x}}x{{y}}
      {% endif %}
    </h3>
  </div>

  <div class="modal-body tabbable tabs-left">

    <ul class="nav nav-tabs">
      {% if place %}
      <li><a href="#pgf-cell-description" class="pgf-cell-description-button" data-toggle="tab">Описание</a></li>
      <li><a href="#pgf-cell-persons" class="pgf-cell-persons-button" data-toggle="tab">Жители</a></li>
      <li><a href="#pgf-cell-place-parameters" class="pgf-cell-place-parameters-button" data-toggle="tab">Параметры</a></li>
      <li><a href="#pgf-cell-place-bills" class="pgf-cell-place-bills-button" data-toggle="tab">Законы</a></li>
      <li><a href="#pgf-cell-place-modifiers" class="pgf-cell-place-modifiers-button" data-toggle="tab">Специализация</a></li>
      <li><a href="#pgf-cell-place-chronicle" class="pgf-cell-place-chronicle-button" data-toggle="tab">События</a></li>
      {% endif %}
      {% if building %}
      <li><a href="#pgf-cell-building" class="pgf-cell-building-button" data-toggle="tab">Строение</a></li>
      {% endif %}
      <li><a href="#pgf-cell-map" class="pgf-cell-map-button" data-toggle="tab">Карта</a></li>
      {% if resource.account.is_authenticated() and resource.account.is_staff %}
      <li><a href="#pgf-cell-debug" class="pgf-cell-debug-button" data-toggle="tab">Отладка</a></li>
      {% endif %}
    </ul>

    <div class="pgf-scrollable tab-content" style="max-height: 360px; overflow-y: auto;">
      {% if place %}
      <div class="tab-pane active description" id="pgf-cell-description">
        {% if place.description %}
        {{ place.description_html|safe }}
        {% else %}
        У этого места пока нет описания
        {% endif %}
      </div>

      <div class="tab-pane" id="pgf-cell-persons">

        <i class="icon-info-sign pull-right"
           style="margin-right: 10px;"
           rel="tooltip"
           title="<ul style='text-align: left;'>
                  <li>в количестве соратников, противников и прописаных героев учитываются только те, что оказывают влияние на мир;</li>
                  <li>жители — это неигровые персонажи (NPC), обладющие большим влиянием в городе.</li>
                  <ul>"></i>

        <ul class="unstyled">
          <li>основное население: {{dominant_race}}</li>
          <li>
            прописано героев: {{place.heroes_number}},
            <a href="{{url('game:map:places:show', place.id)}}" target="_blank">подробнее</a>
          </li>
        </ul>


        <h3>жители</h3>

        <ul class="unstyled">
          {% for person in place.persons %}
          <li class="person-record">

            <table class="person-table table table-striped table-condensed table-no-highlighting">
              <tbody>
                <tr>
                  <td rowspan="3"
                      class="profession-icon-container"
                      rel="tooltil"
                      title="{{ person.type.text }}">
                    <i class="profession-icon {{person.type.name.lower()}}"></i>
                  </td>

                  <th>
                    {% if hero and hero.preferences.friend and hero.preferences.friend.id == person.id %}
                    <span class="badge badge-success" rel="tooltip" title="соратник">{{ person.name }}</span>
                    {% elif hero and hero.preferences.enemy and hero.preferences.enemy.id == person.id %}
                    <span class="badge badge-important" rel="tooltip" title="противник">{{ person.name }}</span>
                    {% else %}
                    {{ person.name }}
                    {% endif %}

                  </th>

                  <th width="100px">влиятельность</th>
                  <td width="50px">
                    {% if place.total_persons_power %}
                    {% set power = (person.power/place.total_persons_power) %}
                    {% else %}
                    {% set power = 0 %}
                    {% endif %}
                    {{ power|percents }}
                  </td>
                </tr>

                <tr>
                  <th colspan="3">
                      <small>{{ person.gender_verbose }}-{{ person.race_verbose }} {{person.mastery_verbose}}</small>

                      <span class="pull-right">
                        {% if person.time_before_unfreeze.total_seconds() > 0 %}
                        <i class="icon-time pgf-time-before-unfreeze"
                           style="vertical-align: middle;"
                           rel="tooltip"
                           title="недавно в городе и может его покинуть только через {{person.time_before_unfreeze|verbose_timedelta}}"></i>
                        {% endif %}

                        {% if person.has_building %}
                        <i class="icon-home"
                           rel="tooltip"
                           title="владеет строением в окрестностях города"></i>
                        {% endif %}

                        <span rel="tooltip" title="количество соратников/противников">
                          <i class="icon-user"></i> {{person.friends_number}}/{{person.enemies_number}}
                        </span>
                      </span>
                  </th>
                </tr>
              </tbody>

            </table>

          </li>
          {% endfor %}
        </ul>

      </div>

      <div class="tab-pane active description" id="pgf-cell-place-parameters">
        <p>
          Информация по актуальным параметрам города.
        </p>

        <table class="table table-striped table-condensed table-no-highlighting">
          <tr>
            <th>параметр</th>
            <th>значение</th>
            <th>информация</th>
          </tr>
          <tr>
            <th>{{PlaceParametersDescription.PLACE_SIZE[0]}}</th><td>{{place.size}}</td>
            <td>
              <a href="javascript: return;" class="info-link" rel="tooltip"
                 title="{{PlaceParametersDescription.PLACE_SIZE[1]}}">
                подробнее
              </a>
            </td>
          <tr>
            <th>{{PlaceParametersDescription.ECONOMIC_SIZE[0]}}</th><td>{{place.expected_size}}</td>
            <td>
              <a href="javascript: return;" class="info-link" rel="tooltip"
                 title="{{PlaceParametersDescription.ECONOMIC_SIZE[1]}}">
                подробнее
              </a>
            </td>
          </tr>
          <tr>
            <th>{{PlaceParametersDescription.TERRAIN_RADIUS[0]}}</th><td>{{place.terrain_radius}} кл</td>
            <td>
              <a href="javascript: return;" class="info-link" rel="tooltip"
                 title="{{PlaceParametersDescription.TERRAIN_RADIUS[1]}}">
                подробнее
              </a>
            </td>
          </tr>
          <tr>
            <th>{{PlaceParametersDescription.PRODUCTION[0]}}</th> <td>{{place.production}}</td>
            <td>
              <a href="javascript: return;" class="info-link" rel="tooltip"
                 title="{{map_macros.power_incoming_tooltip(PlaceParametersDescription.PRODUCTION[1],
                                                            place.get_production_powers())}}">
                подробнее
              </a>
            </td>
          </tr>
          <tr>
            <th>{{PlaceParametersDescription.GOODS[0]}}</th> <td>{{place.goods}} / {{c.PLACE_GOODS_TO_LEVEL}}</td>
            <td>
              <a href="javascript: return;" class="info-link" rel="tooltip"
                 title="{{PlaceParametersDescription.GOODS[1]}}">
                подробнее
              </a>
            </td>
          </tr>
          <tr>
            <th>{{PlaceParametersDescription.SAFETY[0]}}</th> <td>{{place.safety|percents(2)}}</td>
            <td>
              <a href="javascript: return;" class="info-link" rel="tooltip"
                 title="{{map_macros.power_incoming_tooltip(PlaceParametersDescription.SAFETY[1],
                                                            place.get_safety_powers(), percents=true)}}">
                подробнее
              </a>
            </td>
          </tr>
          <tr>
            <th>{{PlaceParametersDescription.TRANSPORT[0]}}</th> <td>{{place.transport|percents(2)}}</td>
            <td>
              <a href="javascript: return;" class="info-link" rel="tooltip"
                 title="{{map_macros.power_incoming_tooltip(PlaceParametersDescription.TRANSPORT[1],
                                                            place.get_transport_powers(), percents=true)}}">
                подробнее
              </a>
            </td>
          </tr>
          <tr>
            <th>{{PlaceParametersDescription.FREEDOM[0]}}</th> <td>{{place.freedom|percents(2)}}</td>
            <td>
              <a href="javascript: return;" class="info-link" rel="tooltip"
                 title="{{map_macros.power_incoming_tooltip(PlaceParametersDescription.FREEDOM[1],
                                                            place.get_freedom_powers(), percents=true)}}">
                подробнее
              </a>
            </td>
          </tr>
        </table>

      </div>

      <div class="tab-pane active description" id="pgf-cell-place-bills">
        <p>
          Список <strong>активных</strong> законов (действующих в текущий момент), связанных с городом.
        </p>

        {% if exchanges %}

        {% for resource_1, resource_2, place_2, bill in exchanges %}
        <table class="table table-striped table-condensed table-no-highlighting">
          <tbody>
            <tr>
              <td"><a target="_blank" href="{{url('game:bills:show', bill.id)}}">{{bill.caption}}</a></td>
            </tr>
            {% if not bill.duration._is_UNLIMITED %}
            <tr><td>Прекратит действовать через: {{bill.time_before_end|verbose_timedelta}}</td></tr>
            {% endif %}
            {% if not resource_1._is_NONE %}
            <tr><td>{{place_2.name}} получает {{resource_1.text}}</td></tr>
            {% endif %}
            {% if not resource_2._is_NONE %}
            <tr><td>{{place_2.name}} отправляет {{resource_2.text}}</td></tr>
            {% endif %}
          </tbody>
        </table>
        {% endfor %}

        {% else %}
        <p class="alert alert-info">Нет активных законов.</p>
        {% endif %}
      </div>


      <div class="tab-pane active description" id="pgf-cell-place-modifiers">

        <p>
          Чтобы можно было изменить специализацию города, необходимо довести её развитие до {{c.PLACE_TYPE_NECESSARY_BORDER}}.
        </p>
        <p>
          Если город уже имеет специализацию и её развитие опустится ниже {{c.PLACE_TYPE_ENOUGH_BORDER}}, то город перестанет быть специализированным.
        </p>

        <table class="table table-striped table-condensed table-no-highlighting">
          <tr>
            <th>специализация</th>
            <th>развитие</th>
            <th>информация</th>
          </tr>
          {% for modifier in place_modifiers %}
          <tr>
            <th>
              {% if place.modifier == modifier %}
              <i class="icon-star pgf-current-modifier-marker" style="vertical-align: middle;" rel="tooltip" title="текущий тип города"></i>
              {% endif %}
              {{modifier.NAME}}
            </th>
            <td>{{modifier.power|round(2)}}</td>
            <td>
              <a href="javascript: return;"
                 class="info-link"
                 rel="tooltip"
                 title="{{map_macros.power_incoming_tooltip(modifier.DESCRIPTION,
                                                            modifier.power_effects_for_template,
                                                            'размер города',
                                                             modifier.size_modifier|round(2))}}">
                подробнее
              </a>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <div class="tab-pane active description" id="pgf-cell-place-chronicle">

        <p>
          Последние события, связаные с городом.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>дата</th>
              <th>событие</th>
            </tr>
          </thead>
          <tbody>
            {% for record in chronicle_records %}
            {{ chronicle_macros.chronicle_record(record) }}
            {% endfor %}
          </tbody>
        </table>

      </div>

      {% endif %}

      {% if building %}
      <div class="tab-pane active description" id="pgf-cell-building">
        <table class="table table-striped table-condensed table-bordered table-no-highlighting">
          <p>
            Строение увеличивает мастерство владельца, а также получаемое им влияние. Не забывайте о том, что строение необходимо ремонтировать, иначе оно разрушится и его владелец потеряет преимущества, которые давала ему постройка.
          </p>
          <tbody>
            <tr><th width="200px">строение</th><td>{{building.type.text}}</td></tr>
            <tr><th width="200px">название</th><td>{{building.name}}</td></tr>
            <tr><th width="200px">город</th><td>{{building.place.name}}</td></tr>
            <tr><th width="200px">владелец</th><td>{{building.person.name}} {{ building.person.race_verbose }}-{{ building.person.type.text }}</td></tr>
            <tr>
              <th width="200px">целостность</th>
              <td>
                <span class="pgf-building-integrity"
                      data-building-integrity="{{building.integrity}}">
                  {{building.integrity|percents}}
                </span>
              </td>
            </tr>
            <tr><th width="200px">скорость износа</th><td>-{{building.amortization_in_day|percents}} в день</td></tr>
            <tr>
              <th width="200px">рабочих для ремонта</th>
              <td>
                <span class="pgf-building-workers"
                      data-building-workers="{{building.workers_to_full_repairing}}">
                  {{building.workers_to_full_repairing}}
                </span>

                <a href="#"
                   class="angel-ability pgf-ability-buildingrepair pgf-hidden"
                   data-building-id="{{building.id}}"
                   data-building-repair-delta="{{building.repair_delta}}">
                  <i class="icon-tint" rel="tooltip" title="недостаточно энергии"></i>
                  <i class="icon-ban-circle" rel="tooltip" title="Починка зданий разрешена только обладателям подписки"></i>
                  вызвать рабочего
                </a>
                <span style="white-space: nowrap;">(+{{building.repair_delta|percents(points=2)}} за рабочего)</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      {% endif %}


      <div class="tab-pane" id="pgf-cell-map">
        <ul class="unstyled">
          <li>
            {{terrain}},
            {% if nearest_place_name %}
            окрестности {{nearest_place_name}}
            {% else %}
            дикие земли
            {% endif %}
          </li>
          <li>дует {{cell.wind_direction.text}} {{cell.wind_power.text}}</li>
          <li>вокруг {{cell.temperature.text}} и {{cell.wetness.text}}</li>
        </ul>
      </div>

      {% if resource.account.is_authenticated() and resource.account.is_staff %}
      <div class="tab-pane" id="pgf-cell-debug">
      </div>
      {% endif %}
    </div>

  </div>

  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Ok</a>
  </div>

</div>
