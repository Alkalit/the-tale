{% extends "base.html" %}

{% block head %}
{{ super() }}

<script src="{{ STATIC_URL }}game/widgets.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}game/angel.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}game/map/map2.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}game/map/sprites.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}game/data/abilities.js" type="text/javascript"></script>

<script type="text/javascript">

var updater = undefined;
var angelUpdater
var widgets = {};

jQuery(document).ready(function(e){

    {% if resource.angel %}
    updater = new pgf.game.Updater({url: "{{ url('game:info') }}?angel={{ resource.angel.id }}"});
    angelUpdater = new pgf.game.AngelUpdater({url: "{{ url('game:angels:info', resource.angel.id) }}"});
    widgets.switcher = new pgf.game.widgets.WidgetSwitcher();
    {% else %}
    updater = new pgf.game.Updater({url: "{{ url('game:info') }}"});
    {% endif %}

    {% if settings.DEBUG %}
    function DoTurns(number) {
        if (number == 0) {
            setTimeout(function() { 
                updater.Refresh();
                angelUpdater.Refresh();
            }, 1000 );
            return;
        }

        pgf.forms.Post({ action: "{{ url('game:next_turn') }}",
                         OnSuccess: function(e){
                             DoTurns(number-1);
                         }
                       });
    }

    jQuery('.pgf-next-turn').click(function(e){
        e.preventDefault();
        DoTurns(1);
    });

    jQuery('.pgf-next-10-turns').click(function(e){
        e.preventDefault();
        DoTurns(10);
    });

    jQuery('.pgf-next-100-turns').click(function(e){
        e.preventDefault();
        DoTurns(100);
    });

    jQuery('.pgf-next-1000-turns').click(function(e){
        e.preventDefault();
        DoTurns(1000);
    });

    jQuery('.pgf-next-10000-turns').click(function(e){
        e.preventDefault();
        DoTurns(10000);
    });

    {% endif %}

    function RefreshData() {
        if (updater) {
            updater.Refresh();
        }
        if (angelUpdater) {
            angelUpdater.Refresh();
        }
    }

    setTimeout(RefreshData, 0);

    {% if not settings.DEBUG %}
    setInterval(RefreshData, {{ game_settings.TURN_DELAY*1000 }} );
    {% endif %}
});

</script>
{% endblock %}

{% block debug_menu %}
{{ super() }}
<li><a href="#" class="pgf-next-turn">next turn</a></li>
<li><a href="#" class="pgf-next-10-turns">10 turns</a></li>
<li><a href="#" class="pgf-next-100-turns">100 turns</a></li>
<li><a href="#" class="pgf-next-1000-turns">1000 turns</a></li>
<li><a href="#" class="pgf-next-10000-turns">10000 turns</a></li>
{% endblock %}


{% block content %}

<div id="game-page-content">

  <div id="left-column" class="column">
    {% if resource.angel %}

    {% include "heroes/hero_short.html" %}
    {% include "heroes/hero_equipment.html" %}
    {% include "heroes/hero_bag.html" %}

    {% endif %}
  </div>

  <div id="center-column" class="column">
    {% if resource.angel %}

    {% include "game/current-actions.html" %}
    {% include "game/activate_ability.html" %}

    {% else %}

    <div id="login-required-block" class="block"> 
      Вам необходимо <a href="{{ url('accounts:login') }}">войти</a> (или <a href="{{ url('accounts:registration') }}">зарегистрироваться</a>), </br>
      чтобы увидеть информацию о своём герое.
    </div>

    {% endif %}

    {% include "game/map.html" %}
  </div>

  <div id="right-column" class="column">
    {% include "game/time.html" %}

    {% if resource.angel %}

    {% include "game/abilities.html" %}
    {% include "game/log.html" %}
    
    {% endif %}
  </div>

</div>

{% endblock %}
