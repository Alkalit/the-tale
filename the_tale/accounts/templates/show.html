{% extends "accounts/base.html" %}

{% import 'bills/macros.html' as bills_macros with context %}

{% block title %} {{ master_account.nick }} | {{ super() }}{% endblock %}

{% block head %}
{{ super() }}

<script type="text/javascript">

{% if resource.account.is_authenticated() and master_account.id != resource.account.id%}

jQuery(document).ready(function(){

    jQuery('.pgf-new-message').click(function(e){
        e.preventDefault();
        pgf.ui.dialog.Create({ fromUrl: "{{ url('accounts:messages:new', recipients=master_account.id) }}",
                               OnOpen: function(dialog) {
                                   var newMessageForm = new pgf.forms.Form(jQuery('#pgf-new-message-form', dialog),
                                                                           { OnSuccess: function(form, data){ dialog.modal('hide'); }
                                                                           });
                               }
                             });
    });

{% if friendship is none %}

    jQuery('.pgf-friends-request-friendship').click(function(e){
        e.preventDefault();
        pgf.ui.dialog.Create({ fromUrl: "{{ url('accounts:friends:request', friend=master_account.id) }}",
                               OnOpen: function(dialog) {
                                   var friendshipForm = new pgf.forms.Form(jQuery('.pgf-friendship-request', dialog),
                                                                           { OnSuccess: function(form, data){ location.reload(); }
                                                                           });
                               }
                             });
    });

{% endif %}

});

{% endif %}

</script>
{% endblock %}


{% block accounts_content %}

<h2 style="display: inline-block;">{{ master_account.nick_verbose }} <small>могущество: {{ master_hero.might|int }}</small></h2>

{% if resource.account.is_authenticated() and master_account.id != resource.account.id %}
&nbsp;<a class="pgf-new-message" href="#">отправить сообщение</a> /

{% if friendship is none %}<a class="pgf-friends-request-friendship" href="#">добавить в друзья</a>
{% elif friendship.is_confirmed %}<span class="pgf-friends-in-list">в списке друзей</span>
{% elif friendship.friend_1_id == master_account.id %}
<span class="pgf-friends-request-from">
игрок предлагает дружить
<a class="pgf-forms-post-simple" href="{{url('accounts:friends:accept', friend=master_account.id)}}">принять</a> /
<a class="pgf-forms-post-simple" href="{{url('accounts:friends:remove', friend=master_account.id)}}">отказать</a>
</span>
{% else %}<span class="pgf-friends-request-to">вы предложили этому игроку дружить</span>
{% endif %}

{% endif %}

<table class="account-info-table table table-condensed table-striped table-bordered table-no-highlighting">
  <tbody>
    <tr>
      <th>герой</th>
      <th>рейтинги</th>
      <th>форум</th>
    </tr>
    <tr>
      <td rowspan="3" width="150px">
        <ul class="unstyled">
          <li><strong>имя:</strong> <a href="{{ url('game:heroes:show', master_hero.id) }}">{{ master_hero.name }}</a></li>
          <li><strong>пол:</strong> {{ master_hero.gender_verbose }}</li>
          <li><strong>раса:</strong> {{ master_hero.race_verbose }}</li>
          <li><strong>уровень:</strong> {{ master_hero.level }}</li>
          <li><strong>сила:</strong> {{ master_hero.power }}</li>
        </ul>
      </td>

      <td rowspan="3" width="250px">

        {% if rating_values %}
        <ul class="unstyled">
          <li><strong>могущество:</strong> {% if rating_values.might > 0 %}{{ rating_places.might_place }} место{% else %}не участвует{% endif %}</li>
          <li><strong>принятые законы:</strong> {% if rating_values.bills_count > 0 %}{{ rating_places.bills_count_place }} место{% else %}не участвует{% endif %}</li>
          <li><strong>сила героя:</strong> {{ rating_places.power_place }} место</li>
          <li><strong>уровень героя:</strong> {{ rating_places.level_place }} место</li>
          <li><strong>добавленные фразы:</strong> {% if rating_values.phrases_count > 0 %}{{ rating_places.phrases_count_place }} место{% else %}не участвует{% endif %}</li>
          <li><strong>Сражений PvP:</strong> {% if rating_values.pvp_battles_1x1_number > 0 %}{{ rating_places.pvp_battles_1x1_number_place }} место{% else %}не участвует{% endif %}</li>
          <li><strong>Побед PvP:</strong> {% if rating_values.pvp_battles_1x1_victories > 0 %}{{ rating_places.pvp_battles_1x1_victories_place }} место{% else %}не участвует{% endif %}</li>
        </ul>
        {% else %}
        игрок пока не участвует в рейтингах
        {% endif %}

      </td>

      <td>
        <ul class="unstyled">
          <li><a href="{{url('forum:threads:')}}?author={{master_account.id}}">обсуждения, созданные игроком</a> (всего {{threads_count}})</li>
          <li><a href="{{url('forum:threads:')}}?participant={{master_account.id}}">обсуждения с участием игрока</a> (всего {{threads_with_posts}})</li>
        </ul>
      </td>

    </tr>
    <tr>
      <th>Мир</th>
    </tr>
    <tr>
      <td>
        <ul class="unstyled">
          <li><a href="{{ url('game:bills:') }}?owner={{master_account.id}}">законопроекты, инициированые игроком</a> (всего {{bills_count}})</li>
          <li><a href="{{ url('game:phrase-candidates:') }}?author_id={{master_account.id}}">фразы, предложенные игроком</a> (всего {{phrases_count}})</li>
          <li><a href="{{ url('blogs:posts:') }}?author_id={{master_account.id}}">произведения игрока</a> (всего {{folclor_posts_count}})</li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<h4>политика</h4>

<p>Города, которым игрок помогает чаще всего.</p>

<div style="overflow-y: auto; max-height: {{1+27*(1+bills_settings.PLACES__TO_ACCESS_VOTING)}}px; width: 360px;">

  <table class="table table-condensed table-striped table-bordered table-no-highlighting">
    <tbody>
      <tr>
        <th width="30px">№</th>
        <th width="200px">город</th>
        <th width="100px">помогал (раз)</th>
      </tr>
      {% for place, number in master_hero.places_history.get_most_common_places() %}
      <tr>
        <td>{{loop.index}}</td>
        <td>{{place.name}}</td>
        <td>{{number}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

{% if resource.can_moderate_accounts %}

<script type="text/javascript">
jQuery(document).ready( function(e) {

    var awardForm = new pgf.forms.Form(jQuery('#pgf-give-award-form'),
                                               {OnSuccess: function(form, data){location.reload();}});
});
</script>

<br/>
<hr/>

<h3>Выдать награду</h3>

<div class="pgf-account-moderator-block">

  <form id="pgf-give-award-form" method="post" action="{{ url('accounts:give-award', master_account.id) }}" class="block">

    {{ give_award_form.errors_container }}

    {{ give_award_form.type.widget}}
    {{ give_award_form.description.widget }}

    <input type="submit" value="Выдать награду"/>

  </form>

</div>

<h3>Сброс ника</h3>

<a class="btn btn-success pgf-forms-post-simple"
   href="{{ url('accounts:reset-nick', master_account.id) }}"
   data-confirmation="Вы действительно хотите сбросить ник игрока?">сбросить</a>

{% endif %}

{% endblock %}
