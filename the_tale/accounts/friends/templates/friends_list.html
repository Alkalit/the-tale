{% extends "friends/base.html" %}

{% import 'accounts/macros.html' as accounts_macros with context %}

{% block head %}
{{ super() }}

<script type="text/javascript">
jQuery(document).ready(function(){

    var allCheckbox = jQuery('#pgf-friends-checkbox-all');
    var friendCheckboxes = jQuery('.pgf-friends-checkbox');
    var newMessageButton = jQuery('.pgf-new-message-button');

    allCheckbox.change(function(){
        friendCheckboxes.prop("checked", allCheckbox.prop("checked"));
        newMessageButton.toggleClass('disabled', jQuery('.pgf-friends-checkbox:checked').length == 0);
    });

    friendCheckboxes.change(function(){
        var checkedFriendCheckboxes = jQuery('.pgf-friends-checkbox:checked');
        var checkedFriendsNumber = checkedFriendCheckboxes.length;
        allCheckbox.prop("checked", friendCheckboxes.length == checkedFriendsNumber);
        newMessageButton.toggleClass('disabled', checkedFriendsNumber == 0);
    });

    newMessageButton.click(function(e){
        e.preventDefault();

        if (newMessageButton.hasClass('disabled')) return;

        var recipients = [];
        jQuery('.pgf-friends-checkbox:checked').each(function(i, e){
            recipients.push(jQuery(e).val());
        });

        pgf.ui.dialog.Create({ fromUrl: "{{ url('accounts:messages:new') }}?recipients=" + recipients.join(','),
                               OnOpen: function(dialog) {
                                   var newMessageForm = new pgf.forms.Form(jQuery('#pgf-new-message-form', dialog),
                                                                           { OnSuccess: function(form, data){ dialog.modal('hide'); }
                                                                           });
                               }
                             });
    });

});
</script>
{% endblock %}


{% block friends_content %}

<h2 style="margin-bottom: 0.5em;">Друзья</h2>

<ul class="nav nav-pills">
  <li class="active"><a href="{{ url('accounts:friends:') }}">список друзей</a></li>
  <li>
    <a href="{{ url('accounts:friends:candidates') }}">
      предложения дружбы ({% if candidates %}{{candidates|length}}{% else %}нет{%endif %})
    </a>
  </li>
</ul>

{% if friends %}

<button type="button" class="btn pgf-new-message-button disabled">отправить сообщение</button>

<table class="table">

  <thead>
    <tr>
      <th width="16px;"><input type="checkbox" id="pgf-friends-checkbox-all" value="all"></th>
      {{ accounts_macros.account_record_heading() }}
      <th>действия</th>
    </tr>
  </thead>

  <tbody>
    {% for account in friends %}
    <tr class="pgf-account-record">
      <td><input type="checkbox" class="pgf-friends-checkbox" value="{{account.id}}"></td>
      {{ accounts_macros.account_record(account, heroes[account.id]) }}
      <td><a class="pgf-forms-post-simple" href="{{url('accounts:friends:remove', friend=account.id)}}">удалить</a></td>
    </tr>
    {% endfor %}
  </tbody>

</table>

{% else %}
<p class="alert alert-info pgf-no-friends-message">
  Вы ещё не выбрали себе друзей в игре. Предложить игроку дружить можно на его странице.
</p>
{% endif %}

{% endblock %}
